# bot_worker.py
import os
import asyncio
from aiogram import Bot, Dispatcher, types
from aiogram.utils import exceptions
import requests

BOT_TOKEN = os.getenv("BOT_TOKEN")
WEBAPP_URL = os.getenv("WEBAPP_URL")
ADMIN_ID = os.getenv("ADMIN_ID")

if not BOT_TOKEN:
    raise RuntimeError("BOT_TOKEN not set in environment")

bot = Bot(token=BOT_TOKEN)
dp = Dispatcher(bot)

@dp.message_handler(commands=['start'])
async def start_cmd(message: types.Message):
    kb = types.InlineKeyboardMarkup()
    kb.add(types.InlineKeyboardButton(text="ðŸš€ Open EarnQuick", web_app=types.WebAppInfo(url=WEBAPP_URL)))
    text = f"ðŸ‘‹ Hi {message.from_user.first_name or message.from_user.username}!\nEarn by watching ads â€” open the app below."
    await message.answer(text, reply_markup=kb)

@dp.message_handler(commands=['admin_withdraws'])
async def admin_withdraws(message: types.Message):
    if str(message.from_user.id) != str(ADMIN_ID):
        await message.reply("â›” You are not admin.")
        return
    try:
        resp = requests.get(f"{WEBAPP_URL}/api/withdraws")
        data = resp.json()
        if not data.get("success"):
            await message.reply("Failed to fetch withdraws.")
            return
        withdraws = data.get("withdraws", [])
        if not withdraws:
            await message.reply("No withdraw requests.")
            return
        msg = "Withdraw Requests:\n\n"
        for w in withdraws:
            msg += f"ID: {w['id']} | User: {w['telegram_id']} | pts: {w['points']} | acc: {w['account']} | status: {w['status']}\n"
        await message.reply(msg)
    except Exception as e:
        await message.reply("Error fetching withdraws.")

@dp.message_handler(commands=['notify'])
async def notify_admin(message: types.Message):
    if ADMIN_ID:
        await bot.send_message(ADMIN_ID, f"Notify: {message.from_user.id} used /notify")
        await message.reply("Admin notified.")
    else:
        await message.reply("ADMIN_ID not set.")

def start_polling(loop):
    import threading
    import asyncio
    asyncio.set_event_loop(loop)
    from aiogram import executor
    executor.start_polling(dp, skip_updates=True)
